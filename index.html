<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NWA Gorgon Raid Helper</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #0e0e0e;
      color: white;
    }
    header {
      background: #1f1f1f;
      padding: 10px;
      text-align: center;
      font-size: 3em;
      font-weight: bold;
    }
    .monster-buttons, .attack-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
    }
    .monster-buttons button {
      font-size: 1.5em;
    }
    .monster-buttons button, .attack-buttons button {
      background: #333;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 5px;
      transition: background 0.3s;
      text-align: center;
    }
    .monster-buttons button:hover, .attack-buttons button:hover {
      background: #555;
    }
    .monster-buttons button.selected, .attack-buttons button.selected {
      background: #777;
    }
    .attack-buttons button strong {
      font-size: 2em;
      display: block;
      text-align: center;
      margin-bottom: 5px;
    }
    .attack-info {
      text-align: center;
      padding: 20px;
    }
    video {
      max-width: 600px;
      width: 100%;
      margin-top: 10px;
      border-radius: 20px;
    }
    .video-variants {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 15px;
    }

    .video-variant {
      text-align: center;
    }

    .video-variant video {
      width: 400px;
      height: auto;
      max-width: 100%;
      border-radius: 10px;
    }

    #raidplan {
      margin: 20px auto;
      width: 90%;
      max-width: 1200px;
      border: 2px solid #444;
      position: relative;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
    }
    #canvas {
      pointer-events: auto;
    }
    #bgCanvas, #icon-layer {
      pointer-events: none;
    }
    #tools label, #tools button, #tools select, #tools input {
      font-size: 1em;
      padding: 8px;
      margin: 5px;
      border-radius: 8px;
      border: none;
    }
    
    #tools button {
      background-color: #444;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    #tools button:hover {
      background-color: #666;
    }
    
    #tools select, #tools input[type=number], #tools input[type=range] {
      background-color: #222;
      color: white;
    }
    #icon-layer img {
      position: absolute;
      width: 40px;
      cursor: move;
    }
    #icon-bank img {
      width: 40px;
      margin: 5px;
      cursor: grab;
    }
    .type {
      padding: 2px 6px;
      border-radius: 5px;
    }
    .Slash { color: white; }
    .Thrust { color: lightgreen; }
    .Strike { color: rgb(179, 0, 0); }
    .Nature { color: goldenrod; }
    .Fire { color: red; }
    .Ice { color: lightblue; }
    .Void { color: pink; }
    .Lightning { color: yellow; }
    .Arcane { color: #66f; }
    .ranged {
      background: navy;
      color: lightblue;
      padding: 2px 6px;
      border-radius: 5px;
    }
    .melee {
      background: gray;
      color: lightgray;
      padding: 2px 6px;
      border-radius: 5px;
    }
    .Heavy {
      background: darkred;
      color: lightcoral;
      padding: 2px 6px;
      border-radius: 5px;
    }
    .Light {
      background: darkgreen;
      color: lightgreen;
      padding: 2px 6px;
      border-radius: 5px;
    }
    .Magic {
      background: purple;
      color: violet;
      padding: 2px 6px;
      border-radius: 5px;
    }
    .attack-name {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .attack-meta {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
    }
    .status-effect {
      background: #444;
      padding: 20px;
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .status-effect h3 {
      margin: 0 0 15px;
      font-size: 1.5em;
    }

    .status-effect-content {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .status-effect-content img {
      max-width: 300px;
      height: auto;
      border-radius: 10px;
    }

    .status-effect-desc {
      max-width: 500px;
      font-size: 1.1em;
    }

  </style>
</head>
<body>
  <header>NWA Gorgon Raid Helper</header>

  <div class="monster-buttons" id="monsterButtons"></div>
  <div class="attack-buttons" id="attackButtons"></div>

  <div class="attack-info" id="attackInfo"></div>

  <hr />
  <h2 style="text-align: center">Raidplan</h2>

  <div id="tools">
    <button onclick="undo()">↶ Annuler</button>
    <button onclick="redo()">↷ Rétablir</button>
    <label>Color:
      <select id="colorPicker">
        <option value="#FF0000">Rouge</option>
        <option value="#FFA500">Orange</option>
        <option value="#FFFF00">Jaune</option>
        <option value="#00FF00">Vert</option>
        <option value="#0000FF">Bleu</option>
        <option value="#4B0082">Indigo</option>
        <option value="#EE82EE">Violet</option>
        <option value="#000000">Noir</option>
        <option value="#888888">Gris</option>
        <option value="#FFFFFF">Blanc</option>
      </select>
    </label>
    <label>Width: <input type="range" id="thickness" min="1" max="10" value="3"></label>
    <label>Disappears: <input type="checkbox" id="fadeCheckbox"> après <input type="number" id="fadeTime" min="1" value="5"> s</label>
    <button onclick="clearCanvas()">Effacer</button>
    <button onclick="saveImage()">Sauvegarder</button>
    <select id="imageSelect"></select>
    <input type="file" accept="image/*" onchange="setBackground(event)">
  </div>

  <div id="raidplan">
    <canvas id="bgCanvas"></canvas>
    <canvas id="icon-layer"></canvas>
    <canvas id="canvas"></canvas>
  </div>

  <div id="icon-bank" style="text-align: center">
    <img src="icons/tank.png" draggable="true" ondragstart="startDrag(event)">
    <img src="icons/dps.png" draggable="true" ondragstart="startDrag(event)">
    <img src="icons/heal.png" draggable="true" ondragstart="startDrag(event)">
  </div>

  <script>
    let monsters = {};

    fetch('data/monsters.json')
      .then(res => res.json())
      .then(data => {
        monsters = data;
        populateMonsterButtons();
      });

    const monsterButtons = document.getElementById('monsterButtons');
    const attackButtons = document.getElementById('attackButtons');
    const attackInfo = document.getElementById('attackInfo');

    function populateMonsterButtons() {
      Object.entries(monsters).forEach(([monster, data]) => {
        const btn = document.createElement('button');
        btn.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <img src="icons/${data.icon}" style="height: 30px;">
            <span style="font-size: 1.5em;">${monster}</span>
          </div>
        `;
        btn.onclick = () => {
          document.querySelectorAll('.monster-buttons button').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          loadAttacks(monster);
        };
        monsterButtons.appendChild(btn);
      });
    }


    function loadAttacks(monster) {
      attackButtons.innerHTML = '';
      attackInfo.innerHTML = '';
      (monsters[monster].attacks || []).forEach(attack => {
        const btn = document.createElement('button');
        const iconPath = `icons/${attack.type.toLowerCase()}.png`;
        const typeSpan = `<span class="type ${attack.type}">${attack.type}</span>`;
        const rangeSpan = `<span class="${attack.range === 'Ranged' ? 'ranged' : 'melee'}">${attack.range}</span>`;
        const heavySpan = `<span class="${attack.heavy}">${attack.heavy}</span>`;

        btn.innerHTML = `
          <div><strong>${attack.name}</strong></div>
          <div class="attack-meta">
            ${attack.damage} <img src="${iconPath}" style="width: 20px; vertical-align: middle;">
            ${typeSpan} ${rangeSpan} ${heavySpan}
          </div>
        `;
        btn.onclick = () => {
          document.querySelectorAll('.attack-buttons button').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          showAttackInfo(attack);
        };
        attackButtons.appendChild(btn);
      });
    }

    function showAttackInfo(attack) {
      const iconPath = `icons/${attack.type.toLowerCase()}.png`;
      const typeSpan = `<span class="type ${attack.type}">${attack.type}</span>`;
      const rangeSpan = `<span class="${attack.range === 'Ranged' ? 'ranged' : 'melee'}">${attack.range}</span>`;
      const heavySpan = `<span class="${attack.heavy}">${attack.heavy}</span>`;

      let videoHTML = '';
      if (attack.variants) {
        videoHTML = `
          <div class="video-variants">
            ${attack.variants.map(v => `
              <div class="video-variant">
                <div><strong>${v.label}</strong></div>
                <video autoplay loop muted src="videos/${v.video}" type="video/webm"></video>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        videoHTML = `<video autoplay loop muted src="videos/${attack.video}" type="video/webm"></video>`;
      }


      let statusEffectHTML = '';
      if (attack.status_effect) {
        statusEffectHTML = `
          <div class="status-effect">
            <h3>Status Effect applied on hit</h3>
            <div class="status-effect-content">
              <img src="se_images/${attack.status_effect_img}" alt="Status Effect Image">
              <div class="status-effect-desc">${attack.status_effect_desc}</div>
            </div>
          </div>`;
      }

      attackInfo.innerHTML = `
        <div class="attack-name">${attack.name}</div>
        <div class="attack-meta">
          ${attack.damage} <img src="${iconPath}" style="width: 24px; vertical-align: middle;">
          ${typeSpan} ${rangeSpan} ${heavySpan}
        </div>
        ${videoHTML}
        ${statusEffectHTML}
      `;
    }


    // --- RAIDPLAN ---
    
    const bgCanvas = document.getElementById('bgCanvas');
    const canvas = document.getElementById('canvas');
    const iconLayer = document.getElementById('icon-layer');
    const ctx = canvas.getContext('2d');
    const bgCtx = bgCanvas.getContext('2d');
    let drawing = false;
    let drawHistory = [];
    let redoStack = [];

    function resizeCanvases() {
      const width = document.getElementById('raidplan').offsetWidth;
      const height = width * 0.6;
      [bgCanvas, canvas, iconLayer].forEach(c => {
        c.width = width;
        c.height = height;
      });
    }

    window.addEventListener('resize', resizeCanvases);
    resizeCanvases();

    function saveState() {
      drawHistory.push(canvas.toDataURL());
      if (drawHistory.length > 100) drawHistory.shift();
      redoStack = [];
    }

    function undo() {
      if (drawHistory.length > 0) {
        redoStack.push(canvas.toDataURL());
        const img = new Image();
        img.src = drawHistory.pop();
        img.onload = () => ctx.drawImage(img, 0, 0);
      }
    }

    function redo() {
      if (redoStack.length > 0) {
        drawHistory.push(canvas.toDataURL());
        const img = new Image();
        img.src = redoStack.pop();
        img.onload = () => ctx.drawImage(img, 0, 0);
      }
    }

    canvas.addEventListener('mousedown', e => {
      saveState();
      drawing = true;
      ctx.strokeStyle = document.getElementById('colorPicker').value;
      ctx.lineWidth = document.getElementById('thickness').value;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });

    canvas.addEventListener('mousemove', e => {
      if (drawing) {
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
      }
    });

    canvas.addEventListener('mouseup', () => {
      drawing = false;
    });

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function saveImage() {
      const link = document.createElement('a');
      link.download = 'raidplan.png';
      link.href = canvas.toDataURL();
      link.click();
    }

    function setBackground(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = () => {
          bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
          bgCtx.drawImage(img, 0, 0, bgCanvas.width, bgCanvas.height);
        };
        img.src = e.target.result;
      };
      if (file) reader.readAsDataURL(file);
    }

    let draggedIcon = null;

    function startDrag(e) {
      draggedIcon = e.target.cloneNode();
    }

    iconLayer.addEventListener('dragover', e => {
      e.preventDefault();
    });

    iconLayer.addEventListener('drop', e => {
      e.preventDefault();
      if (!draggedIcon) return;

      draggedIcon.style.left = e.offsetX + 'px';
      draggedIcon.style.top = e.offsetY + 'px';
      draggedIcon.style.position = 'absolute';
      draggedIcon.style.cursor = 'move';
      draggedIcon.draggable = true;

      draggedIcon.addEventListener('mousedown', function (e) {
        const icon = this;
        let offsetX = e.offsetX;
        let offsetY = e.offsetY;

        function moveHandler(ev) {
          icon.style.left = (ev.pageX - offsetX) + 'px';
          icon.style.top = (ev.pageY - offsetY) + 'px';
        }

        function upHandler() {
          document.removeEventListener('mousemove', moveHandler);
          document.removeEventListener('mouseup', upHandler);
        }

        document.addEventListener('mousemove', moveHandler);
        document.addEventListener('mouseup', upHandler);
      });

      iconLayer.appendChild(draggedIcon);
    });

  </script>
</body>
</html>
